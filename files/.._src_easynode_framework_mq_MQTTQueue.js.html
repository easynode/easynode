<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../src/easynode/framework/mq/MQTTQueue.js - EasyNode API参考文档</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EasyNode API参考文档" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: EasyNode - 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/#NAMESPACE#.FileService.html">#NAMESPACE#.FileService</a></li>
                                <li><a href="../classes/EasyNode.html">EasyNode</a></li>
                                <li><a href="../classes/easynode.framework.ActionAOP.ActionAOP.html">easynode.framework.ActionAOP.ActionAOP</a></li>
                                <li><a href="../classes/easynode.framework.aop.AOP.html">easynode.framework.aop.AOP</a></li>
                                <li><a href="../classes/easynode.framework.BeanFactory.html">easynode.framework.BeanFactory</a></li>
                                <li><a href="../classes/easynode.framework.cache.CacheStat.html">easynode.framework.cache.CacheStat</a></li>
                                <li><a href="../classes/easynode.framework.cache.ICache.html">easynode.framework.cache.ICache</a></li>
                                <li><a href="../classes/easynode.framework.cache.Memcached.html">easynode.framework.cache.Memcached</a></li>
                                <li><a href="../classes/easynode.framework.cache.Redis.html">easynode.framework.cache.Redis</a></li>
                                <li><a href="../classes/easynode.framework.db.IConnection.html">easynode.framework.db.IConnection</a></li>
                                <li><a href="../classes/easynode.framework.db.IDataSource.html">easynode.framework.db.IDataSource</a></li>
                                <li><a href="../classes/easynode.framework.db.MysqlConnection.html">easynode.framework.db.MysqlConnection</a></li>
                                <li><a href="../classes/easynode.framework.db.MysqlDataSource.html">easynode.framework.db.MysqlDataSource</a></li>
                                <li><a href="../classes/easynode.framework.Logger.html">easynode.framework.Logger</a></li>
                                <li><a href="../classes/easynode.framework.mq.IQueue.html">easynode.framework.mq.IQueue</a></li>
                                <li><a href="../classes/easynode.framework.mq.RedisListQueue.html">easynode.framework.mq.RedisListQueue</a></li>
                                <li><a href="../classes/easynode.framework.mq.RedisQueue.html">easynode.framework.mq.RedisQueue</a></li>
                                <li><a href="../classes/easynode.framework.mvc.Action.html">easynode.framework.mvc.Action</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionArgConverter.html">easynode.framework.mvc.ActionArgConverter</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionContext.html">easynode.framework.mvc.ActionContext</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionExecutor.html">easynode.framework.mvc.ActionExecutor</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionFactory.html">easynode.framework.mvc.ActionFactory</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionFilter.html">easynode.framework.mvc.ActionFilter</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionRequestParameter.html">easynode.framework.mvc.ActionRequestParameter</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionResult.html">easynode.framework.mvc.ActionResult</a></li>
                                <li><a href="../classes/easynode.framework.mvc.CombinedAction.html">easynode.framework.mvc.CombinedAction</a></li>
                                <li><a href="../classes/easynode.framework.mvc.EJSTemplateViewRenderer.html">easynode.framework.mvc.EJSTemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.IActionContextListener.html">easynode.framework.mvc.IActionContextListener</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ITemplateViewRenderer.html">easynode.framework.mvc.ITemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.JadeTemplateViewRenderer.html">easynode.framework.mvc.JadeTemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.JSONView.html">easynode.framework.mvc.JSONView</a></li>
                                <li><a href="../classes/easynode.framework.mvc.MethodDispatchedAction.html">easynode.framework.mvc.MethodDispatchedAction</a></li>
                                <li><a href="../classes/easynode.framework.mvc.Model.html">easynode.framework.mvc.Model</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ModelField.html">easynode.framework.mvc.ModelField</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ModelProxyActionFactory.html">easynode.framework.mvc.ModelProxyActionFactory</a></li>
                                <li><a href="../classes/easynode.framework.mvc.MustacheTemplateViewRenderer.html">easynode.framework.mvc.MustacheTemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.spi.MysqlModelGenerator.html">easynode.framework.mvc.spi.MysqlModelGenerator</a></li>
                                <li><a href="../classes/easynode.framework.mvc.View.html">easynode.framework.mvc.View</a></li>
                                <li><a href="../classes/easynode.framework.plugin.EasyNodePlugin.html">easynode.framework.plugin.EasyNodePlugin</a></li>
                                <li><a href="../classes/easynode.framework.plugin.PluginLoadContext.html">easynode.framework.plugin.PluginLoadContext</a></li>
                                <li><a href="../classes/easynode.framework.queue.MQTTQueue.html">easynode.framework.queue.MQTTQueue</a></li>
                                <li><a href="../classes/easynode.framework.server.AbstractServer.html">easynode.framework.server.AbstractServer</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAActionContext.html">easynode.framework.server.http.KOAActionContext</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOADefaultRoutes.html">easynode.framework.server.http.KOADefaultRoutes</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAHttpRequestParameter.html">easynode.framework.server.http.KOAHttpRequestParameter</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAHttpServer.html">easynode.framework.server.http.KOAHttpServer</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAHttpServer.SessionSupport.html">easynode.framework.server.http.KOAHttpServer.SessionSupport</a></li>
                                <li><a href="../classes/easynode.framework.server.KOAMemorySessionStorage.html">easynode.framework.server.KOAMemorySessionStorage</a></li>
                                <li><a href="../classes/easynode.framework.server.ServerStat.html">easynode.framework.server.ServerStat</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.Decoder.html">easynode.framework.server.tcp.Decoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.Encoder.html">easynode.framework.server.tcp.Encoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.Message.html">easynode.framework.server.tcp.Message</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.MessageHandler.html">easynode.framework.server.tcp.MessageHandler</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.protocols.JSONDecoder.html">easynode.framework.server.tcp.protocols.JSONDecoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.protocols.JSONEncoder.html">easynode.framework.server.tcp.protocols.JSONEncoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.protocols.JSONMessageHandler.html">easynode.framework.server.tcp.protocols.JSONMessageHandler</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.StreamDecoderHelper.html">easynode.framework.server.tcp.StreamDecoderHelper</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.StreamEncoderHelper.html">easynode.framework.server.tcp.StreamEncoderHelper</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.TCPClient.html">easynode.framework.server.tcp.TCPClient</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.TCPServer.html">easynode.framework.server.tcp.TCPServer</a></li>
                                <li><a href="../classes/easynode.framework.test.TestCase.html">easynode.framework.test.TestCase</a></li>
                                <li><a href="../classes/easynode.framework.test.TestCaseRunner.html">easynode.framework.test.TestCaseRunner</a></li>
                                <li><a href="../classes/easynode.framework.util.Binary.html">easynode.framework.util.Binary</a></li>
                                <li><a href="../classes/easynode.framework.util.HTTPUtil.html">easynode.framework.util.HTTPUtil</a></li>
                                <li><a href="../classes/easynode.framework.util.MustacheHelper.html">easynode.framework.util.MustacheHelper</a></li>
                                <li><a href="../classes/easynode.framework.util.MyError.html">easynode.framework.util.MyError</a></li>
                                <li><a href="../classes/easynode.framework.util.ObjectWrapper.html">easynode.framework.util.ObjectWrapper</a></li>
                                <li><a href="../classes/easynode.framework.util.SqlUtil.html">easynode.framework.util.SqlUtil</a></li>
                                <li><a href="../classes/easynode.framework.util.StringUtil.html">easynode.framework.util.StringUtil</a></li>
                                <li><a href="../classes/easynode.framework.util.VersionComparator.html">easynode.framework.util.VersionComparator</a></li>
                                <li><a href="../classes/easynode.framework.view.TemplateView.html">easynode.framework.view.TemplateView</a></li>
                                <li><a href="../classes/easynode.GenericObject.html">easynode.GenericObject</a></li>
                                <li><a href="../classes/全局函数.html">全局函数</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../src/easynode/framework/mq/MQTTQueue.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var assert = require(&#x27;assert&#x27;);
var logger = using(&#x27;easynode.framework.Logger&#x27;).forFile(__filename);
var IQueue = using(&#x27;easynode.framework.mq.IQueue&#x27;);
var GenericPool = require(&#x27;generic-pool&#x27;);
var mqtt = require(&#x27;mqtt&#x27;);
var _ = require(&#x27;underscore&#x27;);
var thunkify = require(&#x27;thunkify&#x27;);

(function () {
        const DEFAULT_POOL_OPTS = {
                min: 2,
                max: 10,
                idleTimeoutMillis: 30000,
                log: false
        };

        const DEFAULT_CONNECT_OPTS = {
                maxWaitCount : 100,
                waitForConnections : true,
                connectTimeout : 1000
        };

        /**
         * Class MQTTQueue
         *
         * @class easynode.framework.queue.MQTTQueue
         * @extends easynode.framework.mq.IQueue
         * @since 0.1.0
         * @author zlbbq
         * */
        class MQTTQueue extends IQueue {
                /**
                 * 构造函数。
                 *
                 * @method 构造函数
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                constructor() {
                        super();
                        //调用super()后再定义子类成员。
                }

                /**
                 * 初始化连接参数。
                 *
                 * @method get
                 * @param {String} url MQTT协议连接字符串：mqtt://127.0.0.1
                 * @param {String} name 默认mqtt
                 * @param {Object} poolOpts 连接池参数
                 * @param {Object} connectOpts 连接参数
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                initialize (url = &#x27;mqtt://127.0.0.1&#x27;, name = &#x27;mqtt&#x27;, poolOpts = DEFAULT_POOL_OPTS, connectOpts = DEFAULT_CONNECT_OPTS) {
                        var me = this;
                        this.url = url;
                        this.poolOpts = poolOpts;
                        this.connectOpts = connectOpts;
                        var poolArgs = _.extend(poolOpts, {
                                name: name,
                                create: function (callback) {
                                        var client = mqtt.connect(url, connectOpts);
                                        setTimeout(function(){
                                                if(!client.connected) {
                                                        client.end();
                                                        callback(null, client);
                                                }
                                        }, connectOpts.connectTimeout || 1000);


                                        client.once(&#x27;connect&#x27;, function () {
                                                client.once(&#x27;offline&#x27;, function(){
                                                        logger.error(&#x27;mqtt client lost connection&#x27;);
                                                        me.pool.destroy(client);
                                                        //这个函数调用会引起程序崩溃并且无法捕捉异常，监听process的uncaughtException事件可以阻止程序崩溃。
                                                });
                                                callback(null, client);
                                        });

                                        //client.once(&#x27;offline&#x27;, function (err) {
                                        //        logger.error(&#x27;mqtt client is offline: &#x27; + err);
                                        //        callback(null, client);
                                        //});
                                },

                                destroy: function (client) {
                                        try {
                                                client.end();
                                        }catch(err) {}
                                }
                        });
                        this.pool = GenericPool.Pool(poolArgs);
                }

                /**
                 * 向队列发送消息。
                 *
                 * @method getDefaultOpts
                 * @return {Object} 返回默认队列选项
                 * @async
                 * @abstract
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                static getDefaultOpts() {
                        return {qos: MQTTQueue.QoS_NORMAL, retain: false};
                }

                /**
                 * 向队列发送消息。
                 *
                 * @method publish
                 * @param {String} queueName 队列名称
                 * @param {Object} opts 发送选项，取决于队列的协议和驱动程序
                 * @param {Object} msgs JSON对象，可一次发送多条消息
                 * @return {boolean} 消息发送结果
                 * @async
                 * @abstract
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                publish(queueName=&#x27;defaultQueue&#x27;, opts = {qos: MQTTQueue.QoS_NORMAL, retain: false}, ...msgs) {
                        assert(msgs.length &gt; 0, &#x27;Invalid argument&#x27;);
                        opts = opts || MQTTQueue.getDefaultOpts();
                        var me = this;
                        return function * () {
                                if(me.pool.availableObjectsCount() == 0 &amp;&amp; me.pool.waitingClientsCount() &gt;= me.connectOpts.maxWaitCount) {
                                        logger.warn(&#x27;No more available mqtt clients, ***WARNING: acquire suspending will happen&#x27;);
                                        if(me.connectOpts.waitForConnections !== true) {
                                                return false;
                                        }
                                }
                                var fnAcquire = thunkify(me.pool.acquire);
                                var client = yield fnAcquire.call(me.pool);
                                if(client.connected === true) {
                                        var fnPublish = thunkify(client.publish);
                                        for (var i = 0; i &lt; msgs.length; i++) {
                                                var s = JSON.stringify(msgs[i]);
                                                EasyNode.DEBUG &amp;&amp; logger.debug(&#x60;send to mqtt queue[${me.url}]: ${s}&#x60;);
                                                yield fnPublish.call(client, queueName, s, opts);
                                        }
                                        me.pool.release(client);
                                        return true;
                                }
                                else {
                                        me.pool.destroy(client);
                                        logger.error(&#x60;Can not connect to mqtt [${me.url}]&#x60;);
                                        return false;
                                }
                        };
                }

                /**
                 * 订阅队列消息。
                 *
                 * @method subscribe
                 * @param {String} queueName 队列名称
                 * @param {Object} opts 订阅选项，接受一个选项qos
                 * @param {Object} l 队列监听器，具有一个onMessage和onError函数，
                 *                                              函数原型：onMessage (queueName, msg) {}，queueName类型：string，msg类型：object，
                 *                                                                 onError(err) {},  err : 错误实例
                 * @return {Object} 订阅实例，需要通过unsubscribe释放资源, 如果返回null则表示订阅失败
                 * @async
                 * @abstract
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                subscribe(queueName=&#x27;defaultQueue&#x27;, opts={qos: MQTTQueue.QoS_NORMAL}, l=null) {
                        assert(l &amp;&amp; typeof l.onMessage == &#x27;function&#x27;, &#x27;Invalid argument&#x27;);
                        opts = opts || {qos: MQTTQueue.QoS_NORMAL};
                        var me = this;
                        return function * () {
                                if(me.pool.availableObjectsCount() == 0 &amp;&amp; me.pool.waitingClientsCount() &gt;= me.connectOpts.maxWaitCount) {
                                        logger.warn(&#x27;No more available mqtt clients, ***WARNING: acquire suspending will happen&#x27;);
                                        if(me.connectOpts.waitForConnections !== true) {
                                                return null;
                                        }
                                }
                                var fnAcquire = thunkify(me.pool.acquire);
                                var client = yield fnAcquire.call(me.pool);
                                if(!client.connected) {
                                        me.pool.destroy(client);
                                        logger.error(&#x60;Can not connect to mqtt [${me.url}]&#x60;);
                                        return null;
                                }
                                var fnSubscribe = thunkify(client.subscribe);
                                yield fnSubscribe.call(client, queueName, opts);
                                client.on(&#x27;message&#x27;,  function(queueName, msg) {
                                        try{
                                                msg = JSON.parse(msg);
                                                l.onMessage(queueName, msg);
                                        }catch(e){
                                                logger.error(&#x60;Invalid queued string [${msg}] serialized fail&#x60;);
                                        }
                                });
                                client.once(&#x27;offline&#x27;, function(){
                                        if(typeof l.onError == &#x27;function&#x27;) {
                                                l.onError(new Error(&#x27;offline&#x27;));
                                        }
                                });
                                return {
                                        client : client
                                };
                        };
                }

                /**
                 * 取消订阅队列消息。
                 *
                 * @method unsubscribe
                 * @param {Object} subscribeInst subscribe函数的返回值
                 * @async
                 * @abstract
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                unsubscribe(subscribeInst) {
                        assert(subscribeInst &amp;&amp; subscribeInst.client, &#x27;Invalid argument&#x27;);
                        var me = this;
                        return function * () {
                                me.pool.release(subscribeInst.client);
                        };
                }

                getClassName() {
                        return EasyNode.namespace(__filename);
                }
        }

        /**
         * 服务质量 - 一般服务。消息最多被传递一次，比如一般类广告，通知，不保证消息一定能到达。
         *
         * @property MQTTQueue.QoS_NORMAL
         * @type number
         * @default 0
         * @static
         * @since 0.1.0
         * @author zlbbq
         * */
        MQTTQueue.QoS_NORMAL = 0;

        /**
         * 服务质量 - 保证消息到达，但可能重复。应用场景示例：账户余额通知
         *
         * @property MQTTQueue.QoS_GUARANTEE
         * @type number
         * @default 0
         * @static
         * @since 0.1.0
         * @author zlbbq
         * */
        MQTTQueue.QoS_GUARANTEE = 1;

        /**
         * 服务质量 - 保证消息到达并且保证消息的一次到达。应用场景示例：消费通知
         *
         * @property MQTTQueue.QoS_GUARANTEE_ONCE
         * @type number
         * @default 0
         * @static
         * @since 0.1.0
         * @author zlbbq
         * */
        MQTTQueue.QoS_GUARANTEE_ONCE = 2;

        module.exports = MQTTQueue;
})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
