<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../src/easynode/framework/aop/AOP.js - EasyNode API参考文档</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="EasyNode API参考文档" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: EasyNode - 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/#NAMESPACE#.FileService.html">#NAMESPACE#.FileService</a></li>
                                <li><a href="../classes/EasyNode.html">EasyNode</a></li>
                                <li><a href="../classes/easynode.framework.ActionAOP.ActionAOP.html">easynode.framework.ActionAOP.ActionAOP</a></li>
                                <li><a href="../classes/easynode.framework.aop.AOP.html">easynode.framework.aop.AOP</a></li>
                                <li><a href="../classes/easynode.framework.BeanFactory.html">easynode.framework.BeanFactory</a></li>
                                <li><a href="../classes/easynode.framework.cache.CacheStat.html">easynode.framework.cache.CacheStat</a></li>
                                <li><a href="../classes/easynode.framework.cache.ICache.html">easynode.framework.cache.ICache</a></li>
                                <li><a href="../classes/easynode.framework.cache.Memcached.html">easynode.framework.cache.Memcached</a></li>
                                <li><a href="../classes/easynode.framework.cache.Redis.html">easynode.framework.cache.Redis</a></li>
                                <li><a href="../classes/easynode.framework.db.IConnection.html">easynode.framework.db.IConnection</a></li>
                                <li><a href="../classes/easynode.framework.db.IDataSource.html">easynode.framework.db.IDataSource</a></li>
                                <li><a href="../classes/easynode.framework.db.MysqlConnection.html">easynode.framework.db.MysqlConnection</a></li>
                                <li><a href="../classes/easynode.framework.db.MysqlDataSource.html">easynode.framework.db.MysqlDataSource</a></li>
                                <li><a href="../classes/easynode.framework.Logger.html">easynode.framework.Logger</a></li>
                                <li><a href="../classes/easynode.framework.mq.IQueue.html">easynode.framework.mq.IQueue</a></li>
                                <li><a href="../classes/easynode.framework.mq.RedisListQueue.html">easynode.framework.mq.RedisListQueue</a></li>
                                <li><a href="../classes/easynode.framework.mq.RedisQueue.html">easynode.framework.mq.RedisQueue</a></li>
                                <li><a href="../classes/easynode.framework.mvc.Action.html">easynode.framework.mvc.Action</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionArgConverter.html">easynode.framework.mvc.ActionArgConverter</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionContext.html">easynode.framework.mvc.ActionContext</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionExecutor.html">easynode.framework.mvc.ActionExecutor</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionFactory.html">easynode.framework.mvc.ActionFactory</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionFilter.html">easynode.framework.mvc.ActionFilter</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionRequestParameter.html">easynode.framework.mvc.ActionRequestParameter</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ActionResult.html">easynode.framework.mvc.ActionResult</a></li>
                                <li><a href="../classes/easynode.framework.mvc.CombinedAction.html">easynode.framework.mvc.CombinedAction</a></li>
                                <li><a href="../classes/easynode.framework.mvc.EJSTemplateViewRenderer.html">easynode.framework.mvc.EJSTemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.IActionContextListener.html">easynode.framework.mvc.IActionContextListener</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ITemplateViewRenderer.html">easynode.framework.mvc.ITemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.JadeTemplateViewRenderer.html">easynode.framework.mvc.JadeTemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.JSONView.html">easynode.framework.mvc.JSONView</a></li>
                                <li><a href="../classes/easynode.framework.mvc.MethodDispatchedAction.html">easynode.framework.mvc.MethodDispatchedAction</a></li>
                                <li><a href="../classes/easynode.framework.mvc.Model.html">easynode.framework.mvc.Model</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ModelField.html">easynode.framework.mvc.ModelField</a></li>
                                <li><a href="../classes/easynode.framework.mvc.ModelProxyActionFactory.html">easynode.framework.mvc.ModelProxyActionFactory</a></li>
                                <li><a href="../classes/easynode.framework.mvc.MustacheTemplateViewRenderer.html">easynode.framework.mvc.MustacheTemplateViewRenderer</a></li>
                                <li><a href="../classes/easynode.framework.mvc.spi.MysqlModelGenerator.html">easynode.framework.mvc.spi.MysqlModelGenerator</a></li>
                                <li><a href="../classes/easynode.framework.mvc.View.html">easynode.framework.mvc.View</a></li>
                                <li><a href="../classes/easynode.framework.plugin.EasyNodePlugin.html">easynode.framework.plugin.EasyNodePlugin</a></li>
                                <li><a href="../classes/easynode.framework.plugin.PluginLoadContext.html">easynode.framework.plugin.PluginLoadContext</a></li>
                                <li><a href="../classes/easynode.framework.queue.MQTTQueue.html">easynode.framework.queue.MQTTQueue</a></li>
                                <li><a href="../classes/easynode.framework.server.AbstractServer.html">easynode.framework.server.AbstractServer</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAActionContext.html">easynode.framework.server.http.KOAActionContext</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOADefaultRoutes.html">easynode.framework.server.http.KOADefaultRoutes</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAHttpRequestParameter.html">easynode.framework.server.http.KOAHttpRequestParameter</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAHttpServer.html">easynode.framework.server.http.KOAHttpServer</a></li>
                                <li><a href="../classes/easynode.framework.server.http.KOAHttpServer.SessionSupport.html">easynode.framework.server.http.KOAHttpServer.SessionSupport</a></li>
                                <li><a href="../classes/easynode.framework.server.KOAMemorySessionStorage.html">easynode.framework.server.KOAMemorySessionStorage</a></li>
                                <li><a href="../classes/easynode.framework.server.ServerStat.html">easynode.framework.server.ServerStat</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.Decoder.html">easynode.framework.server.tcp.Decoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.Encoder.html">easynode.framework.server.tcp.Encoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.Message.html">easynode.framework.server.tcp.Message</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.MessageHandler.html">easynode.framework.server.tcp.MessageHandler</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.protocols.JSONDecoder.html">easynode.framework.server.tcp.protocols.JSONDecoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.protocols.JSONEncoder.html">easynode.framework.server.tcp.protocols.JSONEncoder</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.protocols.JSONMessageHandler.html">easynode.framework.server.tcp.protocols.JSONMessageHandler</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.StreamDecoderHelper.html">easynode.framework.server.tcp.StreamDecoderHelper</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.StreamEncoderHelper.html">easynode.framework.server.tcp.StreamEncoderHelper</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.TCPClient.html">easynode.framework.server.tcp.TCPClient</a></li>
                                <li><a href="../classes/easynode.framework.server.tcp.TCPServer.html">easynode.framework.server.tcp.TCPServer</a></li>
                                <li><a href="../classes/easynode.framework.test.TestCase.html">easynode.framework.test.TestCase</a></li>
                                <li><a href="../classes/easynode.framework.test.TestCaseRunner.html">easynode.framework.test.TestCaseRunner</a></li>
                                <li><a href="../classes/easynode.framework.util.Binary.html">easynode.framework.util.Binary</a></li>
                                <li><a href="../classes/easynode.framework.util.HTTPUtil.html">easynode.framework.util.HTTPUtil</a></li>
                                <li><a href="../classes/easynode.framework.util.MustacheHelper.html">easynode.framework.util.MustacheHelper</a></li>
                                <li><a href="../classes/easynode.framework.util.MyError.html">easynode.framework.util.MyError</a></li>
                                <li><a href="../classes/easynode.framework.util.ObjectWrapper.html">easynode.framework.util.ObjectWrapper</a></li>
                                <li><a href="../classes/easynode.framework.util.SqlUtil.html">easynode.framework.util.SqlUtil</a></li>
                                <li><a href="../classes/easynode.framework.util.StringUtil.html">easynode.framework.util.StringUtil</a></li>
                                <li><a href="../classes/easynode.framework.util.VersionComparator.html">easynode.framework.util.VersionComparator</a></li>
                                <li><a href="../classes/easynode.framework.view.TemplateView.html">easynode.framework.view.TemplateView</a></li>
                                <li><a href="../classes/easynode.GenericObject.html">easynode.GenericObject</a></li>
                                <li><a href="../classes/全局函数.html">全局函数</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../src/easynode/framework/aop/AOP.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
var assert = require(&#x27;assert&#x27;);
var logger = using(&#x27;easynode.framework.Logger&#x27;).forFile(__filename);
var GenericObject = using(&#x27;easynode.GenericObject&#x27;);
var _ = require(&#x27;underscore&#x27;);
var fs = require(&#x27;fs&#x27;);

(function () {
        /**
         * Class AOP
         *
         * @class easynode.framework.aop.AOP
         * @extends easynode.GenericObject
         * @since 0.1.0
         * @author zlbbq
         * */
        class AOP extends GenericObject {
                /**
                 * 构造函数。
                 *
                 * @method 构造函数
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                constructor() {
                        super();
                        //调用super()后再定义子类成员。
                }

                /**
                 * AOP before。功能：在A函数执行前先行执行B函数，使用B函数的返回值（必须是一个数组）作为A函数的参数。A函数：被拦截函数，
                 * B函数：拦截函数。
                 *
                 * @method before
                 * @param {String/Object/Class} namespace 全类名或对象或类
                 * @param {String} methodName 要拦截的函数名（被拦截函数）
                 * @param {Function/generator} fnBefore 拦截函数，此函数可以是普通函数或generator函数，取决于syncMode，如果是AOP.SYNC则为同步函数
                 * 　　　　　　　　　　　　　　 如果是AOP.ASYNC则为一个generator函数(异步函数)。为了避免generator中的this指针引用问题，建议使用一个返回
                 *                                                      generator的高阶函数替代纯generator函数。
                 *                                                      拦截函数的参数与被拦截函数的参数相同
                 * @param {String} syncMode &quot;sync/async&quot;，AOP.SYNC/AOP.ASYNC，表示被拦截的函数的类型，ASYNC表示拦截的函数是一个generator函数
                 *                                                      注意：拦截函数的类型(sync/async)必须与被拦截函数的类型一致
                 * @return {Array} 返回一个数组，该数组中的元素依次作为被拦截函数的参数传入(Function.apply)。如果不需要修改参数，可以return arguments;
                 * @static
                 * @since 0.1.0
                 * @author zlbbq
                 * @example
                 *              var obj = {
                 *                      name : &#x27;ABC&#x27;,
                 *                      sayHello : function(hello) {
                 *                              console.log(this.name + &#x27;-&gt;&#x27; + hello);
                 *                              this.name = &#x27;abc&#x27;;
                 *                      }
                 *              };
                 *
                 *              AOP.before(obj, &#x27;sayHello&#x27;, function(){
                 *                      console.log(&#x27;Before-&gt;&#x27; + this.name);
                 *                      return [&#x27;PPP&#x27;];                                                        //实际传递到obj.sayHello的函数的参数hello变成了&quot;PPP&quot;
                 *              });
                 * */
                static before(namespace, methodName, fnBefore, syncMode=AOP.SYNC) {
                        var o = null;
                        assert(namespace, &#x27;Invalid arguments&#x27;);
                        if(typeof namespace == &#x27;string&#x27;) {
                                o = using(namespace);
                        }
                        else if(typeof namespace == &#x27;object&#x27; || typeof namespace == &#x27;function&#x27;) {
                                o = namespace;
                        }
                        else {
                                throw new Error(&#x27;Invalid argument [namesapce]&#x27;);
                        }
                        if(typeof o == &#x27;function&#x27;) {
                                var srcFn = o.prototype[methodName];
                                assert(typeof srcFn == &#x27;function&#x27;, &#x27;Invalid argument [methodName], not a function&#x27;);
                                if(syncMode == AOP.ASYNC) {
                                        o.prototype[methodName] = function() {
                                                var ctx = this;
                                                var args = arguments;
                                                return function * () {
                                                        return yield srcFn.apply(ctx, yield fnBefore.apply(ctx, args));
                                                };
                                        };
                                }
                                else {
                                        o.prototype[methodName] = function() {
                                                return srcFn.apply(this, fnBefore.apply(this, arguments));
                                        };
                                }
                        }
                        else if(typeof o == &#x27;object&#x27;) {
                                var srcFn = o[methodName];
                                assert(typeof srcFn == &#x27;function&#x27;, &#x27;Invalid argument [methodName], not a function&#x27;);
                                if(syncMode == AOP.ASYNC) {
                                        o[methodName] = function() {
                                                var ctx = this;
                                                var args = arguments;
                                                return function * () {
                                                        return yield srcFn.apply(ctx, yield fnBefore.apply(ctx, args));
                                                };
                                        };
                                }
                                else {
                                        o[methodName] = function() {
                                                return srcFn.apply(this, fnBefore.apply(this, arguments));
                                        };
                                }
                        }
                }

                /**
                 * AOP after。功能：在A函数执行后执行B函数，A函数的返回值作为B函数的传入参数，B函数的返回值作为A函数的最终返回值。A函数：被拦截函数，
                 * B函数：拦截函数。
                 *
                 * @method after
                 * @param {String/Object/Class} namespace 全类名或对象或类
                 * @param {String} methodName 要拦截的函数名（被拦截函数）
                 * @param {Function/generator} fnAfter 拦截函数，此函数可以是普通函数或generator函数，取决于syncMode，如果是AOP.SYNC则为同步函数
                 * 　　　　　　　　　　　　　　 如果是AOP.ASYNC则为一个generator函数(异步函数)。为了避免generator中的this指针引用问题，建议使用一个返回
                 *                                                      generator的高阶函数替代纯generator函数。
                 *                                                      拦截函数的参数与被拦截函数的参数相同
                 * @param {String} syncMode &quot;sync/async&quot;，AOP.SYNC/AOP.ASYNC，表示被拦截的函数的类型，ASYNC表示拦截的函数是一个generator函数
                 *                                                      注意：拦截函数的类型(sync/async)必须与被拦截函数的类型一致
                 * @return {any} 该返回值将作为被拦截函数的实际返回值
                 * @static
                 * @since 0.1.0
                 * @author zlbbq
                 * @example
                 *              var obj = {
                 *                      name : &#x27;ABC&#x27;,
                 *                      sayHello : function(hello) {
                 *                              console.log(this.name + &#x27;-&gt;&#x27; + hello);
                 *                              this.name = &#x27;abc&#x27;;
                 *                      }
                 *              };
                 *
                 *              AOP.after(obj, &#x27;sayHello&#x27;, function(ret){
                 *                      console.log(&#x27;After-&gt;&#x27; + this.name);
                 *              });
                 * */
                static after(namespace, methodName, fnAfter, syncMode=AOP.SYNC) {
                        var o = null;
                        assert(namespace, &#x27;Invalid arguments&#x27;);
                        if(typeof namespace == &#x27;string&#x27;) {
                                o = using(namespace);
                        }
                        else if(typeof namespace == &#x27;object&#x27;) {
                                o = namespace;
                        }
                        else {
                                throw new Error(&#x27;Invalid argument [namesapce]&#x27;);
                        }
                        if(typeof o == &#x27;function&#x27;) {
                                var srcFn = o.prototype[methodName];
                                assert(typeof srcFn == &#x27;function&#x27;, &#x27;Invalid argument [methodName], not a function&#x27;);
                                if(syncMode == AOP.ASYNC) {
                                        o.prototype[methodName] = function() {
                                                var ctx = this;
                                                var args = arguments;
                                                return function * () {
                                                        var ret = yield srcFn.apply(ctx, args);
                                                        ret = yield fnAfter.call(ctx, ret);
                                                        return ret;
                                                };
                                        };
                                }
                                else {
                                        o.prototype[methodName] = function() {
                                                return fnAfter.call(this, srcFn.apply(this, arguments));
                                        };
                                }
                        }
                        else if(typeof o == &#x27;object&#x27;) {
                                var srcFn = o[methodName];
                                assert(typeof srcFn == &#x27;function&#x27;, &#x27;Invalid argument [methodName], not a function&#x27;);
                                if(syncMode == AOP.ASYNC) {
                                        o[methodName] = function() {
                                                var ctx = this;
                                                var args = arguments;
                                                return function * () {
                                                        var ret = yield srcFn.apply(ctx, args);
                                                        ret = yield fnAfter.call(ctx, ret);
                                                        return ret;
                                                };
                                        };
                                }
                                else {
                                        o[methodName] = function() {
                                                fnAfter.call(this, srcFn.apply(this, arguments));
                                        };
                                }
                        }
                }

                /**
                 * 从JSON文件描述中初始化AOP模块。
                 *
                 * @method initialize
                 * @param {String} ... 拦截器描述文件（多参），描述对象Notation:
                 *                                                                              {
                 *                                                                                       &quot;target&quot; : &quot;easynode.framework.util.SqlUtil&quot;,
                 *                                                                                       &quot;interceptor&quot; : &quot;easynode.tests.SqlUtilInterceptor&quot;,
                 *                                                                                       &quot;method&quot; : &quot;replaceMysqlArgs&quot;,
                 *                                                                                       &quot;mode&quot; : &quot;sync&quot;,
                 *                                                                                       &quot;when&quot; : &quot;before&quot;
                 *                                                                               }
                 * @static
                 * @since 0.1.0
                 * @author zlbbq
                 * */
                static initialize() {
                        for(var i = 0;i&lt;arguments.length;i++) {
                                var file = EasyNode.real(arguments[i]);
                                var intercepts = JSON.parse(fs.readFileSync(file).toString());
                                assert(_.isArray(intercepts), &#x27;Invalid interceptor description, not an array&#x27;);
                                intercepts.forEach(o =&gt; {
                                        o[&#x27;mode&#x27;] = (o[&#x27;mode&#x27;] || AOP.SYNC).toLowerCase();
                                        o[&#x27;when&#x27;] = o[&#x27;when&#x27;].toLowerCase();
                                        assert(o[&#x27;mode&#x27;] == AOP.SYNC || o[&#x27;mode&#x27;] == AOP.ASYNC, &#x27;Invalid method mode, set to &quot;sync&quot; or &quot;async&quot;&#x27;);
                                        assert(o[&#x27;when&#x27;] == AOP.BEFORE || o[&#x27;when&#x27;] == AOP.AFTER, &#x27;Invalid interceptor, set &quot;when&quot; to &quot;before&quot; or &quot;after&quot;&#x27;);
                                        var namespace = using(o[&#x27;target&#x27;]);
                                        var interceptor = using(o[&#x27;interceptor&#x27;]);
                                        var implMethodName = o[&#x27;when&#x27;] + &#x27;_&#x27; + o[&#x27;method&#x27;];
                                        AOP[o[&#x27;when&#x27;]].call(null, namespace, o[&#x27;method&#x27;], interceptor[implMethodName], o[&#x27;mode&#x27;]);
                                });
                        }
                }

                getClassName() {
                        return EasyNode.namespace(__filename);
                }
        }

        AOP.BEFORE = &#x27;before&#x27;;
        AOP.AFTER = &#x27;after&#x27;;
        AOP.SYNC = &#x27;sync&#x27;;
        AOP.ASYNC = &#x27;async&#x27;;

        module.exports = AOP;
})();
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
